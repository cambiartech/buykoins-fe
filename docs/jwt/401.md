# Frontend 401 Error Handling Guide

## Overview

The backend now returns **error codes** with 401 responses to help the frontend distinguish between different types of unauthorized errors. This allows the frontend to decide when to log users out vs. when to show error messages.

## Error Codes

### Should LOG OUT User

These error codes indicate the user's session is invalid and they should be logged out:

| Error Code | Description | When It Occurs |
|------------|-------------|----------------|
| `AUTH_TOKEN_INVALID` | Token is malformed or invalid | Invalid JWT token format |
| `AUTH_TOKEN_EXPIRED` | Token has expired | JWT token expired |
| `AUTH_TOKEN_NOT_ACTIVE` | Token not yet active | Token used before activation time |
| `AUTH_REQUIRED` | No authentication provided | Missing Authorization header |
| `AUTH_ACCOUNT_SUSPENDED` | Account is suspended/disabled | User/admin account is suspended |
| `AUTH_ACCOUNT_NOT_FOUND` | Account doesn't exist | User/admin account deleted |
| `AUTH_UNAUTHORIZED` | Generic unauthorized (default) | Other auth failures |

### Should NOT LOG OUT User

These error codes indicate a login/authentication attempt failed, but the user should NOT be logged out:

| Error Code | Description | When It Occurs |
|------------|-------------|----------------|
| `AUTH_CREDENTIALS_INVALID` | Wrong email/password | Login attempt with wrong credentials |
| `AUTH_EMAIL_NOT_VERIFIED` | Email not verified | Login attempt with unverified email |

## Response Format

All 401 responses now include an `errorCode` field:

```json
{
  "success": false,
  "message": "Invalid credentials",
  "errorCode": "AUTH_CREDENTIALS_INVALID"
}
```

## Frontend Implementation

### Example: React/Next.js

```javascript
// apiClient.js or axios interceptor
import axios from 'axios';

// Create axios instance
const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
});

// Response interceptor
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      const errorCode = error.response.data?.errorCode;
      
      // Error codes that should log out
      const logoutErrorCodes = [
        'AUTH_TOKEN_INVALID',
        'AUTH_TOKEN_EXPIRED',
        'AUTH_TOKEN_NOT_ACTIVE',
        'AUTH_REQUIRED',
        'AUTH_ACCOUNT_SUSPENDED',
        'AUTH_ACCOUNT_NOT_FOUND',
        'AUTH_UNAUTHORIZED',
      ];
      
      if (logoutErrorCodes.includes(errorCode)) {
        // Log user out
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login';
      } else {
        // Don't log out, just show error
        // This handles AUTH_CREDENTIALS_INVALID and AUTH_EMAIL_NOT_VERIFIED
        console.error('Login error:', error.response.data.message);
      }
    }
    
    return Promise.reject(error);
  }
);

export default apiClient;
```

### Example: Vue.js

```javascript
// api.js
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.VUE_APP_API_URL,
});

// Response interceptor
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      const errorCode = error.response.data?.errorCode;
      
      const logoutErrorCodes = [
        'AUTH_TOKEN_INVALID',
        'AUTH_TOKEN_EXPIRED',
        'AUTH_TOKEN_NOT_ACTIVE',
        'AUTH_REQUIRED',
        'AUTH_ACCOUNT_SUSPENDED',
        'AUTH_ACCOUNT_NOT_FOUND',
        'AUTH_UNAUTHORIZED',
      ];
      
      if (logoutErrorCodes.includes(errorCode)) {
        // Log user out
        store.dispatch('auth/logout');
        router.push('/login');
      }
    }
    
    return Promise.reject(error);
  }
);

export default api;
```

### Example: Vanilla JavaScript

```javascript
// api.js
const API_BASE_URL = 'http://localhost:3001/api';

const logoutErrorCodes = [
  'AUTH_TOKEN_INVALID',
  'AUTH_TOKEN_EXPIRED',
  'AUTH_TOKEN_NOT_ACTIVE',
  'AUTH_REQUIRED',
  'AUTH_ACCOUNT_SUSPENDED',
  'AUTH_ACCOUNT_NOT_FOUND',
  'AUTH_UNAUTHORIZED',
];

async function apiRequest(url, options = {}) {
  const token = localStorage.getItem('token');
  
  const headers = {
    'Content-Type': 'application/json',
    ...options.headers,
  };
  
  if (token) {
    headers.Authorization = `Bearer ${token}`;
  }
  
  try {
    const response = await fetch(`${API_BASE_URL}${url}`, {
      ...options,
      headers,
    });
    
    if (response.status === 401) {
      const data = await response.json();
      const errorCode = data.errorCode;
      
      if (logoutErrorCodes.includes(errorCode)) {
        // Log user out
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login';
        return;
      }
    }
    
    if (!response.ok) {
      throw new Error(data.message || 'Request failed');
    }
    
    return await response.json();
  } catch (error) {
    console.error('API request failed:', error);
    throw error;
  }
}

export default apiRequest;
```

## Error Code Reference

### Complete List

```javascript
const AUTH_ERROR_CODES = {
  // Log out user
  TOKEN_INVALID: 'AUTH_TOKEN_INVALID',
  TOKEN_EXPIRED: 'AUTH_TOKEN_EXPIRED',
  TOKEN_NOT_ACTIVE: 'AUTH_TOKEN_NOT_ACTIVE',
  REQUIRED: 'AUTH_REQUIRED',
  ACCOUNT_SUSPENDED: 'AUTH_ACCOUNT_SUSPENDED',
  ACCOUNT_NOT_FOUND: 'AUTH_ACCOUNT_NOT_FOUND',
  UNAUTHORIZED: 'AUTH_UNAUTHORIZED',
  
  // Don't log out
  CREDENTIALS_INVALID: 'AUTH_CREDENTIALS_INVALID',
  EMAIL_NOT_VERIFIED: 'AUTH_EMAIL_NOT_VERIFIED',
};
```

## Testing

### Test Cases

1. **Expired Token**: Should log out
   - Wait for token to expire
   - Make API request
   - Should receive `AUTH_TOKEN_EXPIRED`
   - Should be logged out

2. **Invalid Token**: Should log out
   - Use malformed token
   - Make API request
   - Should receive `AUTH_TOKEN_INVALID`
   - Should be logged out

3. **Wrong Credentials**: Should NOT log out
   - Try to login with wrong password
   - Should receive `AUTH_CREDENTIALS_INVALID`
   - Should NOT be logged out
   - Should show error message

4. **Unverified Email**: Should NOT log out
   - Try to login with unverified email
   - Should receive `AUTH_EMAIL_NOT_VERIFIED`
   - Should NOT be logged out
   - Should show verification message

## Migration Guide

### Before

```javascript
// Old code - logs out on any 401
if (error.response?.status === 401) {
  logout();
}
```

### After

```javascript
// New code - checks error code
if (error.response?.status === 401) {
  const errorCode = error.response.data?.errorCode;
  const shouldLogout = [
    'AUTH_TOKEN_INVALID',
    'AUTH_TOKEN_EXPIRED',
    // ... other logout codes
  ].includes(errorCode);
  
  if (shouldLogout) {
    logout();
  }
}
```

## Best Practices

1. **Always check errorCode**: Don't just check status code
2. **Handle gracefully**: Show appropriate messages for non-logout errors
3. **Update tokens**: If token expired, try refresh token first
4. **User feedback**: Show clear messages for each error type

## Notes

- Error codes are always included in 401 responses
- If `errorCode` is missing, default to `AUTH_UNAUTHORIZED` (should log out)
- Error codes are case-sensitive
- All error codes start with `AUTH_` prefix
