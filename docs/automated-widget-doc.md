# Widget System Documentation

## Table of Contents
1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Database Schema](#database-schema)
4. [API Endpoints](#api-endpoints)
5. [Gmail Integration](#gmail-integration)
6. [WebSocket Events](#websocket-events)
7. [Flow Diagrams](#flow-diagrams)
8. [Setup Instructions](#setup-instructions)
9. [Testing Guide](#testing-guide)
10. [Frontend Integration](#frontend-integration)

---

## Overview

The Widget System is an automated multi-step flow that guides users through:
- **Onboarding**: Setting up PayPal credentials for TikTok earnings
- **Withdrawal**: Requesting payouts from their account
- **Deposit**: Adding funds to their account

### Key Features
- ✅ Multi-step guided widget flow
- ✅ Real-time WebSocket updates
- ✅ Gmail integration for PayPal auth codes
- ✅ File upload support (proof/screenshots)
- ✅ Admin dashboard integration
- ✅ Session management with expiration
- ✅ Integration with existing services (onboarding, payouts, transactions)

---

## Architecture

### Module Structure
```
src/widget/
├── entities/
│   └── widget-session.entity.ts      # WidgetSession model
├── dto/
│   ├── init-widget.dto.ts            # Initialize session
│   ├── submit-step.dto.ts            # Submit step data
│   ├── complete-widget.dto.ts       # Complete session
│   └── upload-proof.dto.ts           # Upload file
├── gmail/
│   ├── gmail-reader.service.ts       # Gmail integration service
│   ├── gmail-reader.controller.ts    # Gmail webhook & endpoints
│   ├── gmail-reader.module.ts        # Gmail module
│   └── google-apps-script.js         # Google Apps Script code
├── widget.service.ts                  # Core widget logic
├── widget.controller.ts              # REST API endpoints
├── widget.gateway.ts                 # WebSocket gateway
└── widget.module.ts                  # Widget module
```

### Dependencies
- `DatabaseModule` - Sequelize/PostgreSQL
- `AuthModule` - JWT authentication
- `SupportModule` - Admin notifications & auth codes
- `OnboardingModule` - Onboarding requests
- `PayoutsModule` - Payout processing
- `StorageModule` - AWS S3 file uploads
- `GmailReaderModule` - Gmail integration

---

## Database Schema

### `widget_sessions` Table

```sql
CREATE TABLE widget_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  trigger_type VARCHAR(20) NOT NULL CHECK (trigger_type IN ('onboarding', 'withdrawal', 'deposit')),
  context JSONB DEFAULT '{}',
  current_step VARCHAR(50) NOT NULL,
  completed_steps TEXT[] DEFAULT '{}',
  collected_data JSONB DEFAULT '{}',
  status VARCHAR(20) NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'completed', 'abandoned', 'error')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE
);
```

**Fields:**
- `id`: Unique session identifier
- `user_id`: User who initiated the session
- `trigger_type`: Type of flow (`onboarding`, `withdrawal`, `deposit`)
- `context`: Additional context data (amounts, request IDs, etc.)
- `current_step`: Current step in the flow
- `completed_steps`: Array of completed step names
- `collected_data`: All data collected during the flow
- `status`: Session status (`active`, `completed`, `abandoned`, `error`)
- `expires_at`: Session expiration (1 hour from last activity)

**Indexes:**
- `idx_widget_sessions_user_id` on `user_id`
- `idx_widget_sessions_status` on `status`
- `idx_widget_sessions_expires_at` on `expires_at`
- `idx_widget_sessions_trigger_type` on `trigger_type`

### Note on Auth Codes
- Uses existing `onboarding_auth_codes` table (no new table needed)
- Auth codes are retrieved from Gmail, not generated by system

---

## API Endpoints

### User Endpoints

#### 1. Initialize Widget Session
```http
POST /api/widget/init
Authorization: Bearer <user_jwt_token>
Content-Type: application/json
```

**Request Body:**
```json
{
  "trigger": "onboarding" | "withdrawal" | "deposit",
  "context": {
    "amount": 100.00,  // For withdrawal/deposit
    "payoutId": "uuid" // Optional: existing payout request
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "sessionId": "uuid",
    "currentStep": "request-credentials",
    "trigger": "onboarding",
    "context": {}
  }
}
```

#### 2. Get Session Status
```http
GET /api/widget/session/:sessionId
Authorization: Bearer <user_jwt_token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "sessionId": "uuid",
    "currentStep": "enter-auth-code",
    "trigger": "onboarding",
    "status": "active",
    "completedSteps": ["request-credentials", "waiting-for-admin"],
    "collectedData": {},
    "expiresAt": "2025-01-20T12:00:00Z"
  }
}
```

#### 3. Submit Step Data
```http
POST /api/widget/session/:sessionId/step
Authorization: Bearer <user_jwt_token>
Content-Type: application/json
```

**Request Body:**
```json
{
  "step": "enter-auth-code",
  "data": {
    "authCode": "123456"
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "sessionId": "uuid",
    "currentStep": "tiktok-setup-instructions",
    "nextStep": "confirm-setup",
    "message": "Auth code validated successfully"
  }
}
```

#### 4. Upload Proof/Screenshot
```http
POST /api/widget/session/:sessionId/upload-proof
Authorization: Bearer <user_jwt_token>
Content-Type: multipart/form-data
```

**Form Data:**
- `file`: Image file (PNG, JPG, max 5MB)
- `step`: Current step name (optional)

**Response:**
```json
{
  "success": true,
  "data": {
    "fileUrl": "https://s3.amazonaws.com/bucket/path/to/file.jpg",
    "fileName": "proof.jpg"
  }
}
```

#### 5. Complete Session
```http
POST /api/widget/session/:sessionId/complete
Authorization: Bearer <user_jwt_token>
Content-Type: application/json
```

**Request Body:**
```json
{
  "finalData": {
    "confirmed": true
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "sessionId": "uuid",
    "status": "completed",
    "message": "Onboarding completed successfully"
  }
}
```

#### 6. Get User Sessions
```http
GET /api/widget/sessions
Authorization: Bearer <user_jwt_token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "sessions": [
      {
        "id": "uuid",
        "triggerType": "onboarding",
        "currentStep": "pending-verification",
        "status": "active",
        "createdAt": "2025-01-20T10:00:00Z"
      }
    ]
  }
}
```

### Admin Endpoints

#### 1. Provide Credentials & Get Auth Code
```http
POST /api/admin/widget/:sessionId/provide-credentials
Authorization: Bearer <admin_jwt_token>
Content-Type: application/json
```

**Request Body:**
```json
{
  "paypalEmail": "platform@paypal.com",
  "notes": "Optional notes"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "authCode": "123456" | null,
    "message": "Auth code retrieved from Gmail..." | "No auth code found...",
    "instructions": [
      "1. Check Gmail for PayPal verification email",
      "2. Extract the 6-digit auth code",
      "3. Use POST /api/admin/widget/:sessionId/store-auth-code to store it",
      "4. Send credentials and code to user via support chat"
    ]
  }
}
```

#### 2. Store Auth Code from Gmail
```http
POST /api/admin/widget/:sessionId/store-auth-code
Authorization: Bearer <admin_jwt_token>
Content-Type: application/json
```

**Request Body:**
```json
{
  "authCode": "123456",
  "conversationId": "uuid" // Optional: support conversation ID
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "authCode": "123456",
    "expiresAt": "2025-01-20T12:15:00Z",
    "message": "Auth code stored. Please send PayPal credentials and this auth code to user via support chat or email."
  }
}
```

### Gmail Integration Endpoints

#### 1. Gmail Webhook (Public)
```http
POST /api/gmail/webhook
Content-Type: application/json
```

**Request Body (from Google Apps Script):**
```json
{
  "from": "noreply@paypal.com",
  "subject": "Your PayPal verification code",
  "body": "Your code is: 123456",
  "receivedAt": "2025-01-20T10:00:00Z",
  "authCode": "123456"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Auth code extracted and processed",
  "authCode": "123456"
}
```

#### 2. Fetch Latest Code (Admin Only)
```http
POST /api/gmail/fetch-latest-code
Authorization: Bearer <admin_jwt_token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "authCode": "123456" | null
  }
}
```

---

## Gmail Integration

### Overview
PayPal sends auth codes to your Gmail account when users log in. The system can retrieve these codes either:
1. **Automated**: Via Google Apps Script webhook
2. **Manual**: Admin checks Gmail and stores code

### Google Apps Script Setup

1. **Go to [script.google.com](https://script.google.com)**
2. **Create new project**
3. **Paste the code** from `src/widget/gmail/google-apps-script.js`
4. **Update configuration:**
   ```javascript
   const WEBHOOK_URL = 'https://your-api-domain.com/api/gmail/webhook';
   ```
5. **Set up trigger:**
   - Go to Triggers (clock icon)
   - Add trigger
   - Event: "On new email" OR "Time-driven" (every 1 minute)
   - Function: `checkForPayPalEmails`
6. **Deploy:**
   - Click Deploy → New deployment
   - Type: Web app
   - Execute as: Me
   - Who has access: Only me (or your organization)
   - Deploy

### Environment Variables

Add to `.env`:
```env
GMAIL_EMAIL=your-paypal-email@gmail.com
GMAIL_WEBHOOK_URL=https://your-api.com/api/gmail/webhook
```

### How It Works

1. **User logs into PayPal** → PayPal sends email to your Gmail
2. **Google Apps Script detects email** → Extracts auth code
3. **Sends to webhook** → `/api/gmail/webhook`
4. **System processes code** → Stores in `onboarding_auth_codes` table
5. **Admin retrieves** → Via `/api/admin/widget/:sessionId/provide-credentials`

### Manual Fallback

If automated retrieval fails:
1. Admin checks Gmail manually
2. Extracts 6-digit code from PayPal email
3. Calls `POST /api/admin/widget/:sessionId/store-auth-code` with code
4. System stores code for user validation

---

## WebSocket Events

### Connection
```javascript
const socket = io('http://your-api.com/widget', {
  auth: {
    token: 'user_jwt_token'
  }
});
```

### Events

#### 1. `widget:init`
**Emitted by:** Server when session is initialized
```json
{
  "sessionId": "uuid",
  "currentStep": "request-credentials",
  "trigger": "onboarding"
}
```

#### 2. `widget:step`
**Emitted by:** Server when step is submitted
```json
{
  "sessionId": "uuid",
  "currentStep": "enter-auth-code",
  "nextStep": "tiktok-setup-instructions",
  "message": "Step completed successfully"
}
```

#### 3. `widget:complete`
**Emitted by:** Server when session is completed
```json
{
  "sessionId": "uuid",
  "status": "completed",
  "message": "Onboarding completed successfully"
}
```

#### 4. `widget:status`
**Emitted by:** Server on status updates
```json
{
  "sessionId": "uuid",
  "status": "active" | "completed" | "abandoned" | "error",
  "currentStep": "pending-verification"
}
```

#### 5. `widget:error`
**Emitted by:** Server on errors
```json
{
  "sessionId": "uuid",
  "error": "Invalid auth code",
  "step": "enter-auth-code"
}
```

### Frontend Example
```javascript
socket.on('widget:step', (data) => {
  console.log('Step updated:', data);
  // Update UI to show next step
});

socket.on('widget:complete', (data) => {
  console.log('Session completed:', data);
  // Show success message
});

socket.on('widget:error', (data) => {
  console.error('Error:', data.error);
  // Show error message
});
```

---

## Flow Diagrams

### Onboarding Flow

```
1. User clicks "Start Onboarding"
   ↓
2. POST /api/widget/init { trigger: "onboarding" }
   ↓
3. Session created → Step: "request-credentials"
   ↓
4. User submits → POST /api/widget/session/:id/step
   ↓
5. Admin notified → Step: "waiting-for-admin"
   ↓
6. Admin provides credentials → POST /api/admin/widget/:id/provide-credentials
   ↓
7. Admin retrieves auth code from Gmail (auto or manual)
   ↓
8. Admin stores code → POST /api/admin/widget/:id/store-auth-code
   ↓
9. User enters code → Step: "enter-auth-code"
   ↓
10. Code validated → Step: "tiktok-setup-instructions"
   ↓
11. User confirms setup → Step: "confirm-setup"
   ↓
12. User submits → Step: "pending-verification"
   ↓
13. Admin verifies → Step: "completed"
   ↓
14. POST /api/widget/session/:id/complete
   ↓
15. Onboarding request created/updated
```

### Withdrawal Flow

```
1. User clicks "Request Withdrawal"
   ↓
2. POST /api/widget/init { trigger: "withdrawal", context: { amount: 100 } }
   ↓
3. Step: "collecting-amount"
   ↓
4. User confirms amount → Step: "collecting-proof"
   ↓
5. User uploads proof → POST /api/widget/session/:id/upload-proof
   ↓
6. Step: "confirming-paypal"
   ↓
7. User confirms PayPal → Step: "pending-admin"
   ↓
8. Admin processes → Step: "completed"
   ↓
9. POST /api/widget/session/:id/complete
   ↓
10. Payout request created
```

### Deposit Flow

```
1. User clicks "Add Funds"
   ↓
2. POST /api/widget/init { trigger: "deposit", context: { amount: 100 } }
   ↓
3. Step: "collecting-amount"
   ↓
4. User confirms amount → Step: "collecting-proof"
   ↓
5. User uploads proof → POST /api/widget/session/:id/upload-proof
   ↓
6. Step: "confirming-paypal"
   ↓
7. User confirms PayPal → Step: "pending-admin"
   ↓
8. Admin processes → Step: "completed"
   ↓
9. POST /api/widget/session/:id/complete
   ↓
10. Transaction created, balance credited
```

---

## Setup Instructions

### 1. Database Migration

```bash
psql -U postgres -d buytiktokcoins -f database/migrations/add-widget-system-tables.sql
```

### 2. Environment Variables

Add to `.env`:
```env
# Gmail Integration
GMAIL_EMAIL=your-paypal-email@gmail.com
GMAIL_WEBHOOK_URL=https://your-api.com/api/gmail/webhook

# Existing variables (should already be set)
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
AWS_REGION=...
AWS_S3_BUCKET=...
JWT_SECRET=...
DATABASE_URL=...
```

### 3. Google Apps Script Setup

1. Follow instructions in [Gmail Integration](#gmail-integration) section
2. Test with `testEmailProcessing()` function
3. Verify webhook receives emails

### 4. Build & Start

```bash
npm install
npm run build
npm run start:prod
```

### 5. Verify Endpoints

```bash
# Check health
curl http://localhost:3000/api/widget/health

# Test webhook (if Google Apps Script is set up)
curl -X POST http://localhost:3000/api/gmail/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "from": "noreply@paypal.com",
    "subject": "Test",
    "body": "Code: 123456",
    "receivedAt": "2025-01-20T10:00:00Z"
  }'
```

---

## Testing Guide

### Test Onboarding Flow

1. **Create test user account**
2. **Initialize session:**
   ```bash
   curl -X POST http://localhost:3000/api/widget/init \
     -H "Authorization: Bearer <user_token>" \
     -H "Content-Type: application/json" \
     -d '{"trigger": "onboarding"}'
   ```
3. **Submit request credentials step:**
   ```bash
   curl -X POST http://localhost:3000/api/widget/session/<sessionId>/step \
     -H "Authorization: Bearer <user_token>" \
     -H "Content-Type: application/json" \
     -d '{"step": "request-credentials", "data": {}}'
   ```
4. **Admin provides credentials:**
   ```bash
   curl -X POST http://localhost:3000/api/admin/widget/<sessionId>/provide-credentials \
     -H "Authorization: Bearer <admin_token>" \
     -H "Content-Type: application/json" \
     -d '{"paypalEmail": "test@paypal.com"}'
   ```
5. **Admin stores auth code:**
   ```bash
   curl -X POST http://localhost:3000/api/admin/widget/<sessionId>/store-auth-code \
     -H "Authorization: Bearer <admin_token>" \
     -H "Content-Type: application/json" \
     -d '{"authCode": "123456"}'
   ```
6. **User enters auth code:**
   ```bash
   curl -X POST http://localhost:3000/api/widget/session/<sessionId>/step \
     -H "Authorization: Bearer <user_token>" \
     -H "Content-Type: application/json" \
     -d '{"step": "enter-auth-code", "data": {"authCode": "123456"}}'
   ```
7. **Complete session:**
   ```bash
   curl -X POST http://localhost:3000/api/widget/session/<sessionId>/complete \
     -H "Authorization: Bearer <user_token>" \
     -H "Content-Type: application/json" \
     -d '{"finalData": {"confirmed": true}}'
   ```

### Test Withdrawal Flow

1. **Initialize withdrawal:**
   ```bash
   curl -X POST http://localhost:3000/api/widget/init \
     -H "Authorization: Bearer <user_token>" \
     -H "Content-Type: application/json" \
     -d '{"trigger": "withdrawal", "context": {"amount": 100}}'
   ```
2. **Submit amount:**
   ```bash
   curl -X POST http://localhost:3000/api/widget/session/<sessionId>/step \
     -H "Authorization: Bearer <user_token>" \
     -H "Content-Type: application/json" \
     -d '{"step": "collecting-amount", "data": {"amount": 100}}'
   ```
3. **Upload proof:**
   ```bash
   curl -X POST http://localhost:3000/api/widget/session/<sessionId>/upload-proof \
     -H "Authorization: Bearer <user_token>" \
     -F "file=@proof.jpg" \
     -F "step=collecting-proof"
   ```
4. **Complete:**
   ```bash
   curl -X POST http://localhost:3000/api/widget/session/<sessionId>/complete \
     -H "Authorization: Bearer <user_token>" \
     -H "Content-Type: application/json" \
     -d '{"finalData": {"confirmed": true}}'
   ```

### Test Gmail Integration

1. **Send test email to Gmail** (from PayPal or manually)
2. **Check Google Apps Script logs** (View → Logs)
3. **Verify webhook receives data:**
   ```bash
   # Check server logs for webhook calls
   ```
4. **Test manual retrieval:**
   ```bash
   curl -X POST http://localhost:3000/api/gmail/fetch-latest-code \
     -H "Authorization: Bearer <admin_token>"
   ```

---

## Frontend Integration

### Step 1: Initialize Widget

```typescript
// Initialize widget session
const initWidget = async (trigger: 'onboarding' | 'withdrawal' | 'deposit', context?: any) => {
  const response = await fetch('/api/widget/init', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${userToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ trigger, context }),
  });
  const data = await response.json();
  return data.data.sessionId;
};
```

### Step 2: Connect WebSocket

```typescript
import io from 'socket.io-client';

const socket = io('http://your-api.com/widget', {
  auth: { token: userToken },
});

socket.on('widget:step', (data) => {
  // Update UI with new step
  setCurrentStep(data.currentStep);
  setNextStep(data.nextStep);
});

socket.on('widget:complete', (data) => {
  // Show success message
  showSuccess('Flow completed!');
});

socket.on('widget:error', (data) => {
  // Show error
  showError(data.error);
});
```

### Step 3: Submit Step Data

```typescript
const submitStep = async (sessionId: string, step: string, data: any) => {
  const response = await fetch(`/api/widget/session/${sessionId}/step`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${userToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ step, data }),
  });
  return await response.json();
};
```

### Step 4: Upload File

```typescript
const uploadProof = async (sessionId: string, file: File) => {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('step', currentStep);

  const response = await fetch(`/api/widget/session/${sessionId}/upload-proof`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${userToken}`,
    },
    body: formData,
  });
  return await response.json();
};
```

### Step 5: Complete Session

```typescript
const completeSession = async (sessionId: string, finalData: any) => {
  const response = await fetch(`/api/widget/session/${sessionId}/complete`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${userToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ finalData }),
  });
  return await response.json();
};
```

### Example React Component

```tsx
import { useState, useEffect } from 'react';
import io from 'socket.io-client';

function WidgetFlow({ trigger, context }) {
  const [sessionId, setSessionId] = useState(null);
  const [currentStep, setCurrentStep] = useState(null);
  const [socket, setSocket] = useState(null);

  useEffect(() => {
    // Initialize session
    initWidget(trigger, context).then(setSessionId);
  }, []);

  useEffect(() => {
    if (!sessionId) return;

    // Connect WebSocket
    const ws = io('http://your-api.com/widget', {
      auth: { token: userToken },
    });

    ws.on('widget:step', (data) => {
      setCurrentStep(data.currentStep);
    });

    ws.on('widget:complete', () => {
      alert('Flow completed!');
    });

    setSocket(ws);

    return () => ws.disconnect();
  }, [sessionId]);

  const handleSubmit = async (stepData) => {
    await submitStep(sessionId, currentStep, stepData);
  };

  return (
    <div>
      {currentStep === 'request-credentials' && (
        <RequestCredentialsStep onSubmit={handleSubmit} />
      )}
      {currentStep === 'enter-auth-code' && (
        <EnterAuthCodeStep onSubmit={handleSubmit} />
      )}
      {/* ... other steps ... */}
    </div>
  );
}
```

---

## Widget Steps Reference

### Onboarding Steps
1. `request-credentials` - User requests PayPal credentials
2. `waiting-for-admin` - Waiting for admin to provide credentials
3. `enter-auth-code` - User enters 6-digit auth code
4. `tiktok-setup-instructions` - Instructions for TikTok setup
5. `confirm-setup` - User confirms setup is complete
6. `pending-verification` - Waiting for admin verification
7. `completed` - Onboarding complete

### Withdrawal Steps
1. `collecting-amount` - User enters withdrawal amount
2. `collecting-proof` - User uploads proof
3. `confirming-paypal` - User confirms PayPal details
4. `pending-admin` - Waiting for admin approval
5. `completed` - Withdrawal request created

### Deposit Steps
1. `collecting-amount` - User enters deposit amount
2. `collecting-proof` - User uploads payment proof
3. `confirming-paypal` - User confirms PayPal transaction
4. `pending-admin` - Waiting for admin approval
5. `completed` - Deposit processed, balance credited

---

## Error Handling

### Common Errors

1. **Session Expired**
   ```json
   {
     "statusCode": 400,
     "message": "Widget session has expired"
   }
   ```
   **Solution:** Initialize new session

2. **Invalid Step**
   ```json
   {
     "statusCode": 400,
     "message": "Invalid step for current session state"
   }
   ```
   **Solution:** Check current step and submit correct step

3. **Invalid Auth Code**
   ```json
   {
     "statusCode": 400,
     "message": "Invalid or expired auth code"
   }
   ```
   **Solution:** Request new code from admin

4. **File Upload Failed**
   ```json
   {
     "statusCode": 500,
     "message": "Failed to upload file"
   }
   ```
   **Solution:** Check file size/format, retry

---

## Security Considerations

1. **JWT Authentication**: All endpoints require valid JWT token
2. **Session Validation**: Sessions expire after 1 hour of inactivity
3. **User Isolation**: Users can only access their own sessions
4. **Admin Only**: Admin endpoints require admin/super_admin role
5. **File Upload Limits**: 5MB max, image formats only
6. **Webhook Security**: Consider adding secret validation for Gmail webhook

---

## Troubleshooting

### Gmail Integration Not Working
1. Check Google Apps Script logs
2. Verify webhook URL is correct
3. Check if trigger is set up
4. Test webhook endpoint manually

### Session Not Found
1. Check if session expired
2. Verify user has access to session
3. Check database for session record

### Auth Code Not Found
1. Check Gmail for PayPal email
2. Verify Google Apps Script is running
3. Try manual retrieval endpoint
4. Check `onboarding_auth_codes` table

### WebSocket Not Connecting
1. Verify JWT token is valid
2. Check WebSocket namespace (`/widget`)
3. Verify CORS settings
4. Check server logs for connection errors

---

## Support

For issues or questions:
1. Check server logs
2. Review database records
3. Test endpoints with Postman/curl
4. Check Google Apps Script execution logs

---

## Changelog

### Version 1.0.0 (Current)
- ✅ Initial widget system implementation
- ✅ Gmail integration for PayPal auth codes
- ✅ WebSocket real-time updates
- ✅ File upload support
- ✅ Admin endpoints
- ✅ Integration with existing services

---

**Last Updated:** 2025-01-20
**Version:** 1.0.0

